<%- include('../layouts/user/header.ejs') -%>

<main class="main">
  <div class="page-header text-center" style="background-image: url('/assets/images/page-header-bg.jpg')">
    <div class="container">
      <h1 class="page-title">My Orders</h1>
    </div>
  </div>

  <div class="page-content">
    <div class="container">
      <div class="row">
        <% if (orders.length > 0) { %>
          <% orders.forEach(order => { %>
            <div class="col-md-6 col-lg-4 mb-4">
              <div class="card h-100 shadow-sm">
                <div class="card-header bg-primary text-white">
                  <h5 class="mb-0">Order ID: <%= order._id %></h5>
                </div>
                <div class="card-body">
                  <!-- Order Summary -->
                  <p><strong>Order Date:</strong> <%= new Date(order.createdOn).toLocaleDateString() %></p>
                  <p><strong>Payment Method:</strong> <%= order.paymentMethod %></p>
                  <p><strong>Status:</strong> <%= order.status %></p>

                  <h6>Items:</h6>
                  <% order.orderItems.forEach(item => { %>
                    <div class="order-item mb-2 d-flex">
                      <div class="product-image" style="width: 60px; margin-right: 15px;">
                        <img src="<%= item.product.imageURL %>" alt="<%= item.product.name %>" style="width: 100%; border-radius: 5px;">
                      </div>
                      <div>
                        <h6 class="mb-1"><%= item.product.name %></h6>
                        <p class="mb-0">Quantity: <%= item.quantity %></p>
                        <p class="mb-0">Price: ₹<%= item.price %></p>
                      </div>
                    </div>
                  <% }) %>

                  <!-- Order Total -->
                  <h5 class="mt-3">Total: ₹<%= order.orderItems.reduce((total, item) => total + (item.quantity * item.price), 0) %></h5>
                </div>

                <!-- Card Footer with Action Buttons -->
                <div class="card-footer text-center">
                  <a href="/view-orderDetails/<%= order._id %>" class="btn btn-info">View Details</a>
                  <% if (order.status === 'Pending' || order.status === 'Processing') { %>
                    <button class="btn btn-danger btn-cancel-order mt-2" onclick="cancelOrder('<%= order._id%>')">Cancel Order</button>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="col-12">
            <div class="alert alert-info" role="alert">
              You have no orders yet.
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            async function cancelOrder(orderId) {
                const confirmResult = await Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, cancel it!',
                    cancelButtonText: 'No, keep it'
                });
        
                if (confirmResult.isConfirmed) {
                    try {
                        const response = await axios.post('/cancelOrder', { orderId });
        
                        if (response.data.success) {
                            Swal.fire(
                                'Cancelled!',
                                response.data.message,
                                'success'
                            ).then(() => {
                                window.location.reload();
                            });
                        } else {
                            Swal.fire(
                                'Failed!',
                                response.data.message,
                                'error'
                            );
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        Swal.fire(
                            'Error!',
                            'Failed to cancel the order. Please try again.',
                            'error'
                        );
                    }
                }
            }
        </script>


<%- include('../layouts/user/footer.ejs') -%>
